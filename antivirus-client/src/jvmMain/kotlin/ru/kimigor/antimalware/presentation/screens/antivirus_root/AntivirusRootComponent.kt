package ru.kimigor.antimalware.presentation.screens.antivirus_root

import com.arkivanov.decompose.ComponentContext
import com.arkivanov.decompose.childContext
import kotlinx.coroutines.CoroutineDispatcher
import kotlinx.coroutines.Job
import kotlinx.coroutines.flow.MutableStateFlow
import kotlinx.coroutines.flow.asStateFlow
import kotlinx.coroutines.launch
import org.kodein.di.DI
import ru.kimigor.antimalware.data.models.ApiMessage
import ru.kimigor.antimalware.domain.repositories.MessagingRepository
import ru.kimigor.antimalware.presentation.common.Component
import ru.kimigor.antimalware.presentation.dialogs.MessageDialogState
import ru.kimigor.antimalware.presentation.routing.Router
import ru.kimigor.antimalware.presentation.screens.scanner.ScannerComponent
import ru.kimigor.antimalware.presentation.values.strings.strings
import java.util.UUID

class AntivirusRootComponent(
    componentContext: ComponentContext,
    private val router: Router,
    private val messagingRepository: MessagingRepository,
    private val defaultDispatcher: CoroutineDispatcher,
    di: DI
): Component(componentContext) {
    val scannerComponent = ScannerComponent(
        componentContext = childContext(key = UUID.randomUUID().toString()),
        messagingRepository = messagingRepository,
        router = router
    )

    private val _state = MutableStateFlow<AntivirusRootViewState>(AntivirusRootViewState.Loading)
    val state = _state.asStateFlow()

    private val listenersJobs = mutableListOf<Job>()

    init {
        load()
    }

    fun onIntent(intent: AntivirusRootIntent) = componentScope.launch {
        when (intent) {
            AntivirusRootIntent.MessageDialogDismiss -> {
                val state = _state.value

                if (state !is AntivirusRootViewState.Ok) {
                    return@launch
                }

                _state.value = state.copy(messageDialogState = MessageDialogState.Gone)
            }

            AntivirusRootIntent.Reload -> {
                load()
            }
        }
    }

    private fun load() = componentScope.launch {
        _state.value = AntivirusRootViewState.Loading

        when (val result = messagingRepository.isProtectionEnabled()) {
            is ApiMessage.Ok -> {
                _state.value = AntivirusRootViewState.Ok()
                initListeners()
            }

            is ApiMessage.Fail -> {
                _state.value = AntivirusRootViewState.Error(
                    strings.errorMessage(
                        description = result.description,
                        errorCode = result.errorCode
                    )
                )
            }
        }
    }

    private fun initListeners() {
        listenersJobs.forEach(Job::cancel)
        listenersJobs.clear()
    }

    data class Args(
        val componentContext: ComponentContext,
        val router: Router
    )

    companion object {
        fun create(
            args: Args,
            messagingRepository: MessagingRepository,
            defaultDispatcher: CoroutineDispatcher,
            di: DI
        ) = AntivirusRootComponent(
            componentContext = args.componentContext,
            di = di,
            messagingRepository = messagingRepository,
            defaultDispatcher = defaultDispatcher,
            router = args.router
        )
    }
}